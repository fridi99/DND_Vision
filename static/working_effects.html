<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>ThemeFX ‚Äì Demo</title>
    <style>
        :root {
          --overlay-z: 9999;
          --pop-z: 10000;
          --tooltip-z: 10001;
          --panel: #161a22;
          --muted: #9aa4b2;
          --text: #e6e9ef;
          --accent: #7c94ff;
          --ring: 0 0 0 3px rgba(124,148,255,0.45);
        }
        html, body { height: 100%; }

       /* Standard-Hintergrund (Drache) */
    body {
      margin: 0;
      color: var(--text);
      font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.45)),
        url('images/dragon-background.jpeg') center/cover no-repeat fixed;
    }

    /* Blood-Effekt ‚Üí blood_effect.jpg */
    body.effect-blood {
      background:
        linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.45)),
        url('images/blood_effect.jpg') center/cover no-repeat fixed;
    }

    /* Ice-Effekt ‚Üí ice_effect.jpg */
    body.effect-ice {
      background:
        linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)),
        url('images/ice_effect.jpg') center/cover no-repeat fixed;
    }

    /* Fire-Effekt (noch Standard, eigenes Bild kannst du sp√§ter einsetzen) */
    body.effect-fire {
      background:
        linear-gradient(rgba(0,0,0,.45), rgba(0,0,0,.45)),
        url('images/dragon-background.jpeg') center/cover no-repeat fixed;
    }

        .app {
          min-height: 100%;
          display: grid;
          place-items: center;
          padding: 2rem;
        }
        .card {
          background: rgba(255,255,255,0.03);
          backdrop-filter: blur(8px);
          border: 1px solid rgba(255,255,255,0.06);
          border-radius: 16px;
          padding: 24px;
          max-width: 720px;
          width: 100%;
          box-shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        .row { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
        .spacer { height: 1rem; }
        button {
          cursor: pointer;
          border: 1px solid rgba(255,255,255,0.08);
          background: var(--panel);
          color: var(--text);
          padding: .6rem .9rem;
          border-radius: 12px;
          transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
          display: inline-flex; align-items:center; gap:.5rem;
        }
        button:hover { border-color: rgba(255,255,255,0.22); }
        button:active { transform: translateY(1px); }
        button:focus-visible { outline: none; box-shadow: var(--ring); }
        .primary { background: #252c3d; }
        .muted { color: var(--muted); }
        .kbd {
          font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
          font-size: .85em; padding: .1em .4em; border: 1px solid rgba(255,255,255,.15);
          border-bottom-width: 2px; border-radius: 6px; background: rgba(255,255,255,.06);
        }

        /* ---------------- Modal ---------------- */
        .modal-overlay {
          position: fixed; inset: 0; background: rgba(0,0,0,.5);
          display:none; z-index: var(--overlay-z);
        }
        .modal {
          position: fixed; inset: 0; display:none; z-index: var(--pop-z);
          place-items: center; padding: 20px;
        }
        .modal.open, .modal-overlay.open { display:grid; }
        .modal-panel {
          width: 100%; max-width: 560px; background: var(--panel);
          border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:20px;
          box-shadow: 0 30px 80px rgba(0,0,0,.5);
        }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; }
        .modal-title { font-weight: 600; letter-spacing: .3px; }
        .grid {
          display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; margin-top: 10px;
        }
        .fx-btn {
          position: relative;
          padding: 14px; border-radius: 12px; text-align:center;
          user-select: none;
        }
        .fx-btn.active { outline: 2px solid var(--accent); outline-offset: 2px; }
        .fx-icon { font-size: 22px; display:block; }
        .fx-name { display:block; font-weight:600; margin-top:6px; }

        /* --------- Tooltips ---------- */
        .tooltip {
          position: absolute; left: 50%; transform: translateX(-50%);
          bottom: calc(100% + 8px);
          background: #0c0f16; color: var(--text);
          border: 1px solid rgba(255,255,255,.15);
          padding: .45rem .6rem; border-radius: 8px; font-size: 12px;
          white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity .12s ease;
          z-index: var(--tooltip-z);
        }
        .fx-btn:hover .tooltip { opacity: 1; }

        /* ------------- Visual Effects ------------- */
        .effect-blood::after {
          content:""; position: fixed; inset: 0; pointer-events:none; z-index: 9000;
          background:
            radial-gradient(closest-side at 20% 10%, rgba(150,0,0,.65), transparent 60%),
            radial-gradient(closest-side at 75% 0%, rgba(120,0,0,.55), transparent 55%),
            radial-gradient(closest-side at 50% 30%, rgba(200,0,0,.35), transparent 65%);
          mix-blend-mode: multiply;
        }
        .effect-ice {
          filter: saturate(0.85) hue-rotate(-20deg) contrast(1.05);
          position: relative;
        }
        .effect-ice::after {
          content:""; position: fixed; inset:0; pointer-events:none; z-index:9000;
          background:
            repeating-linear-gradient(135deg, rgba(200,230,255,.08) 0 8px, rgba(255,255,255,0) 8px 16px);
          backdrop-filter: blur(1.2px);
        }
        .effect-fire {
          position: relative;
          filter: contrast(1.05) saturate(1.05);
        }
        .effect-fire::after {
          content:""; position: fixed; inset:0; pointer-events:none; z-index:9000;
          background:
            radial-gradient(1200px 200px at 50% 110%, rgba(255,120,0,.55), transparent 60%),
            radial-gradient(900px 160px at 15% 115%, rgba(255,80,0,.35), transparent 60%),
            radial-gradient(900px 160px at 85% 115%, rgba(255,80,0,.35), transparent 60%);
          mix-blend-mode: screen;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="card">
        <h2 style="margin:0 0 .4rem">ThemeFX ‚Äì Effects & API</h2>
        <p class="muted" style="margin:0 0 1rem">
            Click ‚ÄúChoose Effect‚Äù to open a small window. On <strong>hover</strong> you‚Äôll see short explanations.
            You can also control effects via API:
            <code>ThemeFX.apply('blood'|'ice'|'fire')</code>, <code>ThemeFX.clear()</code>.
        </p>
        <div class="row">
            <button id="openFx" class="primary" aria-haspopup="dialog" aria-controls="fxModal">Choose Effect</button>
            <button id="clearFx">Clear Last</button>
            <button id="deleteNearestFx">Delete Nearest</button>
            <button id="escapeFx">Escape</button>
            <button id="nextMapFx">Next Map</button>
            <span class="muted">Current: <span id="currentFx" class="kbd">none</span></span>
        </div>
        <div class="spacer"></div>
        <p class="muted">Tip: Press <span class="kbd">Esc</span> to close the window.</p>
    </div>
</div>

<!-- Modal -->
<div id="fxOverlay" class="modal-overlay" tabindex="-1" aria-hidden="true"></div>
<div id="fxModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="fxTitle">
    <div class="modal-panel">
        <div class="modal-header">
            <div>
                <div id="fxTitle" class="modal-title">Select Effect</div>
                <div class="muted" style="font-size:12px">Pick a visual style for your theme.</div>
            </div>
            <button id="closeFx" aria-label="Close">‚úï</button>
        </div>

        <div class="grid" id="fxGrid" role="listbox" aria-label="Effects">
            <button class="fx-btn" data-fx="blood" role="option" aria-selected="false">
                <span class="fx-icon">ü©∏</span>
                <span class="fx-name">Blood</span>
                <span class="tooltip">Dark, gritty blood overlay</span>
            </button>

            <button class="fx-btn" data-fx="ice" role="option" aria-selected="false">
                <span class="fx-icon">‚ùÑÔ∏è</span>
                <span class="fx-name">Ice</span>
                <span class="tooltip">Cool icy tint & hatch</span>
            </button>

            <button class="fx-btn" data-fx="fire" role="option" aria-selected="false">
                <span class="fx-icon">üî•</span>
                <span class="fx-name">Fire</span>
                <span class="tooltip">Warm glow from below</span>
            </button>
        </div>

        <div class="spacer"></div>
        <div class="row" style="justify-content:flex-end">
            <button id="saveFx" class="primary">Apply</button>
        </div>
    </div>
</div>

<script>

    // ---------- Minimal API ----------
    (function(){
      const CLASS_MAP = { blood: 'effect-blood', ice: 'effect-ice', fire: 'effect-fire' };
      let current = null;

      function apply(name){
        clear();
        const cls = CLASS_MAP[name];
        if(!cls) return;
        document.body.classList.add(cls);
        current = name;
        dispatch('applied', { effect: name });
        updateBadge();
      }
      function clear(){
        Object.values(CLASS_MAP).forEach(c => document.body.classList.remove(c));
        if (current !== null) dispatch('cleared', { previous: current });
        current = null;
        updateBadge();
      }
      function get(){ return current; }
      function dispatch(type, detail){ window.dispatchEvent(new CustomEvent(`themefx:${type}`, { detail })); }
      function updateBadge(){
        document.getElementById('currentFx').textContent = current ?? 'none';
        markActive(current);
      }

      window.ThemeFX = { apply, clear, get, effects: Object.keys(CLASS_MAP) };
    })();

    // ---------- UI / Modal ----------
    const modal = document.getElementById('fxModal');
    const overlay = document.getElementById('fxOverlay');
    const openBtn = document.getElementById('openFx');
    const closeBtn = document.getElementById('closeFx');
    const saveBtn = document.getElementById('saveFx');
    const clearBtn = document.getElementById('clearFx');
    const grid = document.getElementById('fxGrid');

    const FX_TO_TYPE = {
      blood: "s",
      ice:   "c",
      fire:  "r",
    };
    let pendingChoice = null;

    function openModal(){
      overlay.classList.add('open');
      modal.classList.add('open');
      pendingChoice = ThemeFX.get();
      markActive(pendingChoice);
    }
    function closeModal(){
      overlay.classList.remove('open');
      modal.classList.remove('open');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    grid.addEventListener('click', (e)=>{
      const btn = e.target.closest('.fx-btn');
      if(!btn) return;
      pendingChoice = btn.dataset.fx;
      markActive(pendingChoice);
    });

    // Apply
    saveBtn.addEventListener('click', async () => {
      if (pendingChoice) {
        ThemeFX.apply(pendingChoice);
        const payload = { type: FX_TO_TYPE[pendingChoice] };
        if (payload.type) {
          await fetch("/effect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        }
      }
      closeModal();
    });

    // Clear Last
    clearBtn.addEventListener('click', async () => {
      ThemeFX.clear();
      await fetch("/deletelast", { method: "POST" });
      pendingChoice = null;
      markActive(null);
    });

    // Delete Nearest
    document.getElementById('deleteNearestFx').addEventListener('click', async () => {
      await fetch("/deletenearest", { method: "POST" });
    });

    // Escape
    document.getElementById('escapeFx').addEventListener('click', async () => {
      await fetch("/escape", { method: "POST" });
    });

    // Next Map
    document.getElementById('nextMapFx').addEventListener('click', async () => {
      await fetch("/nextmap", { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}" });
    });

    function markActive(name){
      grid.querySelectorAll('.fx-btn').forEach(b=>{
        const active = b.dataset.fx === name;
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', String(active));
      });
    }
</script>
</body>
</html>